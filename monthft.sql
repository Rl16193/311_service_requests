DROP VIEW IF EXISTS monthft;

CREATE VIEW monthft AS
WITH daily_features AS (
	SELECT 
	date,
	-- Add temporal features (month, day of month, day number, monthend and holiday marker)
	EXTRACT(MONTH FROM date) AS month,
	EXTRACT (month FROM date) AS month_of_year,

	CASE 
        WHEN date IN (
            DATE '2025-01-01',DATE'2024-01-01',DATE'2023-01-01', DATE'2023-01-02',DATE'2022-01-01',DATE'2021-01-01',DATE'2020-01-01', DATE '2019-01-01',DATE'2018-01-01',
			DATE'2017-01-01',DATE'2016-01-01',DATE'2015-01-01',DATE'2014-01-01',  -- New Year's Day
            
			DATE '2025-07-01',DATE'2024-07-01',DATE'2023-07-01', DATE '2023-07-03',DATE'2022-07-01',DATE'2021-07-01',DATE'2020-07-01', DATE '2019-07-01',DATE'2018-07-01',
			DATE'2018-07-02',DATE'2017-07-01',DATE'2016-07-01',DATE'2015-07-01',DATE'2014-07-01', -- Canada Day
			
			DATE '2025-02-17',DATE'2024-02-19',DATE'2023-02-20',DATE'2022-02-21',DATE'2021-02-15',DATE'2020-02-17', DATE '2019-02-18',DATE'2018-02-19',
			DATE'2017-02-20',DATE'2016-02-15',DATE'2015-02-16',DATE'2014-02-17', -- Family Day
			
			DATE '2025-04-18',DATE'2024-03-29',DATE'2023-04-07',DATE'2022-04-15',DATE'2021-04-02',DATE'2020-04-10', DATE '2019-04-19',DATE'2018-03-30',
			DATE'2017-04-14',DATE'2016-03-25',DATE'2015-04-03',DATE'2014-04-18', -- Good Friday
			
			DATE '2025-05-19',DATE'2024-05-20',DATE'2023-05-22',DATE'2022-05-23',DATE'2021-05-24',DATE'2020-05-18', DATE '2019-05-20',DATE'2018-05-21',
			DATE'2017-05-22',DATE'2016-05-23',DATE'2015-05-18',DATE'2014-05-19', -- Victoria Day
			
			DATE '2025-08-04',DATE'2024-08-05',DATE'2023-08-07',DATE'2022-08-01',DATE'2021-08-02',DATE'2020-08-03', DATE '2019-08-05',DATE'2018-08-06',
			DATE'2017-08-07',DATE'2016-08-01',DATE'2015-08-03',DATE'2014-08-04', -- Civic Holiday
			
			DATE '2025-09-01',DATE'2024-09-02',DATE'2023-09-04',DATE'2022-09-05',DATE'2021-09-06',DATE'2020-09-07', DATE '2019-09-02',DATE'2018-09-03',
			DATE'2017-09-04',DATE'2016-09-05',DATE'2015-09-07',DATE'2014-09-01', -- Labour Day
			
			DATE '2025-10-13',DATE'2024-10-14',DATE'2023-10-09',DATE'2022-10-10',DATE'2021-10-11',DATE'2020-10-12', DATE '2019-10-14',DATE'2018-10-08',
			DATE'2017-10-09',DATE'2016-10-10',DATE'2015-10-12',DATE'2014-10-13', -- Thanksgiving
			
			DATE '2025-12-25',DATE'2024-12-25',DATE'2023-12-25',DATE'2022-12-25',DATE'2021-12-25',DATE'2020-12-25', DATE '2019-12-25',DATE'2018-12-25',
			DATE'2017-12-25',DATE'2016-12-25',DATE'2015-12-25',DATE'2014-12-25',  -- Christmas
            
			DATE '2025-12-26',DATE'2024-12-26',DATE'2023-12-26',DATE'2022-12-26',DATE'2022-12-27',DATE'2021-12-26',DATE'2021-12-27',DATE'2020-12-26', DATE '2019-12-26',DATE'2018-12-26',
			DATE'2017-12-26',DATE'2016-12-26',DATE'2016-12-27',DATE'2015-12-26',DATE'2014-12-26'   -- Boxing Day
        ) THEN 1 ELSE 0 
    END AS is_holiday,

	-- Add election year feature
	CASE WHEN EXTRACT(YEAR FROM date) IN (2022,2018,2014) THEN 1
	ELSE 0 END AS is_prov_elec,
	CASE WHEN EXTRACT(YEAR FROM date) IN (2015,2019,2021,2025) THEN 1
	ELSE 0 END AS is_nat_elec

	
	FROM daily_weather
)
SELECT
    DATE_TRUNC('month', date)::DATE AS month_start,
	is_prov_elec, is_nat_elec, month_of_year,
    
      -- Counts holidays
    SUM(is_holiday) AS total_holidays,
    
    -- Cyclical features
    ROUND(SIN(2 * PI() * month_of_year / 12)::NUMERIC,2) AS month_of_year_sin,
    ROUND(COS(2 * PI() * month_of_year / 12)::NUMERIC,2) AS month_of_year_cos


FROM daily_features AS d
GROUP BY month_start, month_of_year, is_prov_elec, is_nat_elec
ORDER BY month_start;

SELECT * FROM monthft;
